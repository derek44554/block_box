# 音频播放功能说明

## ✅ 已实现的功能

### 1. 音频播放服务 (`AudioPlayerService`)

基于 `audioplayers` 库实现的音频播放服务：

- ✅ **播放网络音频**：通过 IPFS URL 播放音乐
- ✅ **播放控制**：播放、暂停、停止、恢复
- ✅ **进度管理**：实时跟踪播放进度和音频时长
- ✅ **进度跳转**：支持拖动进度条跳转
- ✅ **音量控制**：支持设置音量（0.0 - 1.0）
- ✅ **状态监听**：自动监听播放状态变化

### 2. 集成到 MusicProvider

- ✅ 播放方法：`play(MusicItem, ipfsGateway)`
- ✅ 控制方法：`pause()`, `resume()`, `stop()`, `togglePlayback()`
- ✅ 导航方法：`playNext()`, `playPrevious()`
- ✅ 进度方法：`seek(Duration)`, `setVolume(double)`
- ✅ 状态获取：`isPlaying`, `duration`, `position`, `progress`

### 3. 增强的播放器 UI

**底部播放器组件** (`MusicPlayer`)：
- ✅ 显示当前播放音乐信息（标题、艺术家）
- ✅ 可点击的进度条（点击跳转）
- ✅ 实时显示播放时间（当前/总时长）
- ✅ 播放控制按钮（上一首/播放·暂停/下一首）
- ✅ 封面显示

**播放列表页面** (`MusicPlayPage`)：
- ✅ 点击音乐项开始播放
- ✅ 显示正在播放的音乐（动态图标）
- ✅ 播放成功/失败提示

## 🎵 使用方法

### 播放音乐

1. 在播放页面点击任意音乐项
2. 系统会自动开始播放
3. 底部会显示播放器控制面板

### 播放控制

- **播放/暂停**：点击中间的圆形按钮
- **上一首/下一首**：点击左右两侧的按钮
- **进度跳转**：点击进度条的任意位置
- **查看进度**：底部显示当前时间/总时长

### IPFS 网关

默认使用 `https://ipfs.io` 作为 IPFS 网关。

音频 URL 格式：`https://ipfs.io/ipfs/{CID}`

例如：
```
https://ipfs.io/ipfs/QmNimAZ4EczFaEU2pzwPAqpRcA4o2s1YmCEdxyaK6Bpiei
```

## 🔧 技术细节

### AudioPlayerService

```dart
// 播放音乐
await audioService.play(music, ipfsGateway: 'https://ipfs.io');

// 暂停
await audioService.pause();

// 恢复
await audioService.resume();

// 跳转
await audioService.seek(Duration(seconds: 30));

// 获取状态
bool isPlaying = audioService.isPlaying;
Duration position = audioService.position;
Duration duration = audioService.duration;
double progress = audioService.progress; // 0.0 - 1.0
```

### MusicProvider 集成

```dart
final musicProvider = context.read<MusicProvider>();

// 播放
await musicProvider.play(musicItem);

// 控制
await musicProvider.togglePlayback();
await musicProvider.playNext();
await musicProvider.playPrevious();

// 进度
await musicProvider.seek(Duration(seconds: 60));
```

## 📊 播放流程

1. **用户点击音乐** → `_playMusic(MusicItem)`
2. **设置播放列表** → `musicProvider.setPlaylist(items)`
3. **开始播放** → `musicProvider.play(item)`
4. **构建 URL** → `https://ipfs.io/ipfs/{CID}`
5. **调用 audioplayers** → `player.play(UrlSource(url))`
6. **监听状态变化** → 更新 UI
7. **显示底部播放器** → 显示进度和控制

## 🎨 UI 特性

### 进度条

- 点击进度条任意位置跳转
- 实时更新播放进度
- 白色半透明样式

### 播放状态

- 播放中：显示暂停图标
- 暂停中：显示播放图标
- 正在播放的音乐：显示动态图标（graphic_eq）

### 时间显示

格式：`MM:SS / MM:SS`
例如：`01:23 / 03:45`

## ⚠️ 注意事项

1. **网络连接**：需要网络连接才能播放 IPFS 音频
2. **IPFS 网关**：如果默认网关速度慢，可以更换其他网关
3. **音频格式**：支持 `.mp3`, `.m4a`, `.aac`, `.ogg`, `.wav`, `.flac`
4. **后台播放**：当前不支持后台播放，切换应用会暂停

## 🐛 调试信息

播放时会输出以下日志：

```
[AudioPlayerService] 播放音乐: 野心
[AudioPlayerService] URL: https://ipfs.io/ipfs/QmNim...
[AudioPlayerService] 播放完成
```

如果播放失败，会显示错误信息。

## 🔮 未来改进

可以考虑的功能：
- [ ] 后台播放
- [ ] 播放模式（顺序、随机、单曲循环）
- [ ] 播放历史
- [ ] 歌词显示
- [ ] 均衡器
- [ ] 睡眠定时器
- [ ] 播放列表编辑
- [ ] 自定义 IPFS 网关

