# 音频缓存功能说明

## ✅ 已实现的功能

### 1. **AudioCacheHelper** - 音频缓存辅助类

提供完整的音频缓存管理功能：

- ✅ **缓存存储**：根据 CID 和扩展名保存音频文件
- ✅ **缓存读取**：快速检查和读取已缓存的音频
- ✅ **缓存删除**：删除指定 CID 的缓存或清空所有缓存
- ✅ **缓存统计**：获取缓存文件数量和占用空间
- ✅ **格式化显示**：人类可读的缓存大小（B/KB/MB/GB）

### 2. **自动缓存机制**

播放音乐时自动缓存：

```
1. 检查本地缓存
   ├─ 有缓存 → 直接播放缓存文件 ⚡
   └─ 无缓存 → 继续下一步

2. 从网络下载
   └─ 下载音频文件

3. 保存到缓存
   └─ 根据 CID 保存

4. 播放缓存文件
   └─ 使用本地文件播放
```

### 3. **缓存管理页面**

在音乐页面右上角点击 📦 图标进入缓存管理：

- ✅ 查看缓存文件数量
- ✅ 查看占用空间大小
- ✅ 刷新缓存信息
- ✅ 清空所有缓存
- ✅ 缓存说明

## 🎵 使用方式

### 自动缓存

1. **首次播放**：
   ```
   点击音乐 → 下载中... → 保存缓存 → 播放
   ```

2. **再次播放**：
   ```
   点击音乐 → 使用缓存 → 立即播放 ⚡
   ```

### 手动管理

1. 点击音乐页面右上角的 📦 图标
2. 查看当前缓存状态
3. 需要时可以清空缓存释放空间

## 📊 缓存策略

### 缓存位置
```
应用数据目录/audio_cache/
├── QmNim...Bpiei.mp3
├── QmAbc...Xyz12.m4a
└── QmDef...Uvw34.aac
```

### 文件命名
- 格式：`{CID}{扩展名}`
- 示例：`QmNimAZ4EczFaEU2pzwPAqpRcA4o2s1YmCEdxyaK6Bpiei.mp3`

### 缓存识别
- 基于 **CID**（内容标识符）
- 相同 CID = 相同内容
- 不会重复下载相同音乐

## 🔧 技术细节

### AudioCacheHelper API

```dart
// 检查缓存
final cachedFile = await AudioCacheHelper.getCachedAudio(cid, '.mp3');

// 保存缓存
await AudioCacheHelper.saveAudioToCache(cid, bytes, '.mp3');

// 删除缓存
await AudioCacheHelper.deleteCachedAudio(cid, '.mp3');

// 清空所有缓存
await AudioCacheHelper.clearAllCache();

// 获取统计信息
final count = await AudioCacheHelper.getCacheCount();
final size = await AudioCacheHelper.getCacheSize();
final formatted = AudioCacheHelper.formatCacheSize(size);
```

### AudioPlayerService 集成

```dart
// 播放流程
1. 检查缓存：getCachedAudio()
2. 有缓存：play(DeviceFileSource(cachedFile.path))
3. 无缓存：
   - 下载：_downloadAudio(url)
   - 保存：saveAudioToCache()
   - 播放：play(DeviceFileSource(savedFile.path))
```

## 📝 调试日志

### 使用缓存时
```
[AudioPlayerService] 播放音乐: 野心
[AudioPlayerService] CID: QmNim...
[AudioCacheHelper] 找到缓存: QmNim....mp3
[AudioPlayerService] 使用缓存文件: /path/to/cache/QmNim....mp3
```

### 首次下载时
```
[AudioPlayerService] 播放音乐: 野心
[AudioPlayerService] CID: QmNim...
[AudioPlayerService] 从网络加载...
[AudioPlayerService] URL: http://...
[AudioPlayerService] 下载完成: 3433951 bytes
[AudioCacheHelper] 保存缓存: QmNim....mp3 (3433951 bytes)
[AudioPlayerService] 已缓存到: /path/to/cache/QmNim....mp3
```

## 💡 优势

### 1. **节省流量**
- 每首歌只下载一次
- 重复播放不消耗流量

### 2. **提升速度**
- 缓存播放几乎瞬间开始
- 无需等待网络下载

### 3. **离线播放**
- 已缓存的音乐可以离线播放
- 不依赖网络连接

### 4. **智能管理**
- 基于 CID 识别，不会重复缓存
- 可以随时查看和清理缓存

## ⚠️ 注意事项

1. **存储空间**：缓存会占用设备存储空间
2. **首次播放**：需要等待下载完成
3. **缓存清理**：清空后需要重新下载
4. **网络要求**：首次播放需要网络连接

## 🔮 未来改进

可以考虑的功能：
- [ ] 缓存大小限制（自动清理旧缓存）
- [ ] 预缓存（提前下载播放列表）
- [ ] 缓存优先级（常听的歌优先保留）
- [ ] 缓存统计（播放次数、最后播放时间）
- [ ] 选择性缓存（手动标记要缓存的歌曲）

## 📈 性能对比

| 场景 | 无缓存 | 有缓存 |
|------|--------|--------|
| 首次播放 | 需要下载 | 需要下载 |
| 再次播放 | 需要下载 | 立即播放 ⚡ |
| 流量消耗 | 每次消耗 | 仅首次消耗 |
| 播放速度 | 取决于网速 | 几乎瞬间 |
| 离线播放 | ❌ 不支持 | ✅ 支持 |

